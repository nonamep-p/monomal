#!/bin/bash

THEME_DIR="$HOME/.config/neofetch/themes"
CONFIG_FILE="$HOME/.config/neofetch/config.conf"

# Ensure themes exist
if [ ! -d "$THEME_DIR" ]; then
    echo "Themes directory not found!"
    exit 1
fi

# Find all files containing print_info() - this is the best way to identify neofetch configs
# We exclude .git and images
echo "Indexing themes... please wait."
THEMES=$(grep -rl "print_info()" "$THEME_DIR" --exclude-dir=".git" --exclude="*.png" --exclude="*.jpg" --exclude="*.md")

if [ -z "$THEMES" ]; then
    echo "No themes found in $THEME_DIR"
    exit 1
fi

# Select with fzf and preview
# We strip the full path to show a nice relative name in fzf
SELECTED=$(echo "$THEMES" | sed "s|$THEME_DIR/||" | fzf \
    --prompt="Select Neofetch Theme > " \
    --height=100% \
    --layout=reverse \
    --border \
    --preview "neofetch --config $THEME_DIR/{}" \
    --preview-window=right:70%)

if [ -n "$SELECTED" ]; then
    FULL_PATH="$THEME_DIR/$SELECTED"
    echo "Applying: $SELECTED"
    
    # Backup current
    cp "$CONFIG_FILE" "${CONFIG_FILE}.bak" 2>/dev/null
    
    # Copy new
    cp "$FULL_PATH" "$CONFIG_FILE"
    
    # Verify copy
    if [ $? -eq 0 ]; then
        echo -e "\n\033[1;32m✔ Theme applied successfully!\033[0m"
        echo "Running preview..."
        neofetch
    else
        echo -e "\n\033[1;31m✖ Failed to apply theme.\033[0m"
    fi
else
    echo "No theme selected."
fi
